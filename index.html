</table>
    </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script>
        // =====================================================================
        // 1. FIREBASE CONFIGURATION (การตั้งค่า FIREBASE)
        // =====================================================================
        // !! สำคัญ: วาง Firebase Config ที่คัดลอกมา ตรงนี้ !!
	const firebaseConfig = {
  		apiKey: "AIzaSyAL_C2PN82y0k1iqc3rzOrqYdxynN7qd3A",
  		authDomain: "checkin-164e0.firebaseapp.com",
  		projectId: "checkin-164e0",
  		storageBucket: "checkin-164e0.firebasestorage.app",
  		messagingSenderId: "83157183999",
  		appId: "1:83157183999:web:725c993e0b9e0f6100cbca",
  		measurementId: "G-WL6LHGYZTQ"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const checkinCollection = db.collection('checkinRecords');
	const app = initializeApp(firebaseConfig);
	const analytics = getAnalytics(app);
        
        let localCheckinRecords = []; // ใช้เก็บข้อมูลที่ดึงมาแสดงผล
        let editingDocId = null; // ใช้เก็บ ID ของเอกสารที่กำลังแก้ไข

        // =====================================================================
        // 2. DATA HANDLING (การจัดการข้อมูล)
        // =====================================================================

        // โหลดข้อมูลจาก Firestore เมื่อเปิดหน้า
        window.addEventListener('load', function() {
            document.getElementById('checkinDate').valueAsDate = new Date();
            
            // ใช้ onSnapshot เพื่อให้ข้อมูลอัพเดทแบบ Real-time
            checkinCollection.orderBy('checkinDate', 'desc').onSnapshot(snapshot => {
                localCheckinRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateRecordsTable();
                console.log("ข้อมูลอัพเดทจาก Firestore แล้ว!");
            }, error => {
                console.error("เกิดข้อผิดพลาดในการดึงข้อมูล: ", error);
            });
        });
        
        // ฟังก์ชันบันทึกข้อมูล (เพิ่ม/อัพเดท)
        document.getElementById('checkinForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const employeeName = document.getElementById('employeeName').value;
            const checkinDate = document.getElementById('checkinDate').value;
            const manday = document.getElementById('manday').checked;
            const traveling = document.getElementById('traveling').checked;
            
            const record = {
                employeeName,
                checkinDate,
                manday,
                traveling,
                timestamp: new Date().toISOString() // ใช้ ISO string เพื่อให้เรียงลำดับได้
            };

            try {
                if (editingDocId) {
                    // อัพเดทข้อมูลเดิม
                    await checkinCollection.doc(editingDocId).update(record);
                    alert('อัพเดทข้อมูลเรียบร้อยแล้ว!');
                    editingDocId = null;
                    document.querySelector('.btn-primary').textContent = 'บันทึกข้อมูล';
                } else {
                    // เพิ่มข้อมูลใหม่
                    await checkinCollection.add(record);
                    alert('บันทึกข้อมูลเรียบร้อยแล้ว!');
                }
                clearForm();
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการบันทึกข้อมูล: ", error);
                alert("เกิดข้อผิดพลาด: " + error.message);
            }
        });

        // ฟังก์ชันล้างฟอร์ม
        function clearForm() {
            document.getElementById('checkinForm').reset();
            document.getElementById('checkinDate').valueAsDate = new Date();
            editingDocId = null;
            document.querySelector('.btn-primary').textContent = 'บันทึกข้อมูล';
        }

        // ฟังก์ชันอัพเดทตาราง
        function updateRecordsTable() {
            const tbody = document.getElementById('recordsTableBody');
            tbody.innerHTML = '';

            localCheckinRecords.forEach(record => {
                const row = tbody.insertRow();
                const checkinDate = new Date(record.checkinDate);
                // เพิ่มเวลา UTC offset ของไทย (+7) เพื่อให้แสดงวันที่ถูกต้อง
                checkinDate.setMinutes(checkinDate.getMinutes() + checkinDate.getTimezoneOffset() + 420);

                row.innerHTML = `
                    <td>${record.employeeName}</td>
                    <td>${checkinDate.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                    <td>${record.manday ? '✅' : '❌'}</td>
                    <td>${record.traveling ? '✅' : '❌'}</td>
                    <td>${new Date(record.timestamp).toLocaleString('th-TH')}</td>
                    <td>
                        <button class="edit-btn" onclick="editRecord('${record.id}')">แก้ไข</button>
                        <button class="delete-btn" onclick="deleteRecord('${record.id}')">ลบ</button>
                    </td>
                `;
            });
        }

        // ฟังก์ชันแก้ไขข้อมูล
        async function editRecord(docId) {
            try {
                const doc = await checkinCollection.doc(docId).get();
                if (!doc.exists) {
                    alert('ไม่พบข้อมูลที่ต้องการแก้ไข!');
                    return;
                }
                const record = doc.data();
                document.getElementById('employeeName').value = record.employeeName;
                document.getElementById('checkinDate').value = record.checkinDate;
                document.getElementById('manday').checked = record.manday;
                document.getElementById('traveling').checked = record.traveling;
                
                editingDocId = docId;
                document.querySelector('.btn-primary').textContent = 'อัพเดทข้อมูล';
                
                document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการดึงข้อมูลเพื่อแก้ไข: ", error);
            }
        }

        // ฟังก์ชันลบข้อมูล
        async function deleteRecord(docId) {
            if (confirm('คุณต้องการลบข้อมูลนี้หรือไม่?')) {
                try {
                    await checkinCollection.doc(docId).delete();
                    alert('ลบข้อมูลเรียบร้อยแล้ว!');
                    // onSnapshot จะอัพเดทตารางให้เอง
                } catch (error) {
                    console.error("เกิดข้อผิดพลาดในการลบข้อมูล: ", error);
                }
            }
        }

        // =====================================================================
        // 3. UTILITY & SUMMARY FUNCTIONS (ฟังก์ชันเสริมและสรุปผล)
        // (ส่วนนี้ใช้ข้อมูลจาก localCheckinRecords ที่ซิงค์มาแล้ว)
        // =====================================================================

        function setCurrentDateTime() {
            document.getElementById('checkinDate').valueAsDate = new Date();
        }

        function showSummary() {
            const summarySection = document.getElementById('summarySection');
            const selectedDate = document.getElementById('checkinDate').value;
            if (!selectedDate) return alert('กรุณาเลือกวันที่');
            
            const dateRecords = localCheckinRecords.filter(r => r.checkinDate === selectedDate);
            document.getElementById('totalCheckins').textContent = dateRecords.length;
            document.getElementById('totalMandays').textContent = dateRecords.filter(r => r.manday).length;
            document.getElementById('totalTraveling').textContent = dateRecords.filter(r => r.traveling).length;

            summarySection.style.display = 'block';
            summarySection.scrollIntoView({ behavior: 'smooth' });
        }

        function showRangeSummary() {
            const rangeSummarySection = document.getElementById('rangeSummarySection');
            document.getElementById('summarySection').style.display = 'none';
            rangeSummarySection.style.display = 'block';
            
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            
            document.getElementById('startDate').valueAsDate = weekAgo;
            document.getElementById('endDate').valueAsDate = today;
            
            calculateRangeSummary();
            rangeSummarySection.scrollIntoView({ behavior: 'smooth' });
        }

        function calculateRangeSummary() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (!startDate || !endDate || new Date(startDate) > new Date(endDate)) {
                return alert('กรุณาเลือกช่วงวันที่ให้ถูกต้อง');
            }
            
            const rangeRecords = localCheckinRecords.filter(r => {
                const recordDate = new Date(r.checkinDate);
                return recordDate >= new Date(startDate) && recordDate <= new Date(endDate);
            });
            
            document.getElementById('rangeCheckins').textContent = rangeRecords.length;
            document.getElementById('rangeMandays').textContent = rangeRecords.filter(r => r.manday).length;
            document.getElementById('rangeTraveling').textContent = rangeRecords.filter(r => r.traveling).length;
            const daysDiff = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('rangeDays').textContent = daysDiff;
            
            createEmployeeBreakdown(rangeRecords);
        }

        function createEmployeeBreakdown(rangeRecords) {
            const employeeBreakdownContent = document.getElementById('employeeBreakdownContent');
            const employeeStats = {};
            rangeRecords.forEach(record => {
                if (!employeeStats[record.employeeName]) {
                    employeeStats[record.employeeName] = { checkins: 0, mandays: 0, traveling: 0 };
                }
                employeeStats[record.employeeName].checkins++;
                if (record.manday) employeeStats[record.employeeName].mandays++;
                if (record.traveling) employeeStats[record.employeeName].traveling++;
            });
            
            let html = `<div class="employee-card" style="background: linear-gradient(45deg, #9C27B0, #673AB7); color: white;"><div class="employee-name">ชื่อพนักงาน</div><div style="text-align: center; font-weight: bold;">Check In</div><div style="text-align: center; font-weight: bold;">Manday</div><div style="text-align: center; font-weight: bold;">Traveling</div></div>`;
            if (Object.keys(employeeStats).length === 0) {
                html = '<p style="text-align: center; color: #666; padding: 20px;">ไม่มีข้อมูลในช่วงวันที่ที่เลือก</p>';
            } else {
                 Object.entries(employeeStats).sort(([a], [b]) => a.localeCompare(b, 'th')).forEach(([name, stats]) => {
                    html += `<div class="employee-card"><div class="employee-name">${name}</div><div class="employee-stat stat-checkin">${stats.checkins}</div><div class="employee-stat stat-manday">${stats.mandays}</div><div class="employee-stat stat-travel">${stats.traveling}</div></div>`;
                });
            }
            employeeBreakdownContent.innerHTML = html;
        }

        function exportData() {
            if (localCheckinRecords.length === 0) return alert('ไม่มีข้อมูลสำหรับ Export');
            
            let csvContent = "ชื่อพนักงาน,วันที่,Manday,Traveling,เวลาบันทึก\n";
            localCheckinRecords.forEach(record => {
                const checkinDate = new Date(record.checkinDate);
                checkinDate.setMinutes(checkinDate.getMinutes() + checkinDate.getTimezoneOffset() + 420);
                const row = [`"${record.employeeName}"`, `"${checkinDate.toLocaleDateString('th-TH')}"`, record.manday ? 'ใช่' : 'ไม่ใช่', record.traveling ? 'ใช่' : 'ไม่ใช่', `"${new Date(record.timestamp).toLocaleString('th-TH')}"`].join(',');
                csvContent += row + "\n";
            });

            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `checkin_records_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
    </body>
</html>
